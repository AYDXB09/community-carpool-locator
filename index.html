<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Community Carpool | Share Rides. Cut Emissions.</title>
    <meta name="description"
        content="A community-driven platform that matches people already travelling similar routes to carpool voluntarily." />

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary: #10b981;
            --primary-light: #34d399;
            --primary-dark: #059669;
            --bg: #ffffff;
            --bg-secondary: #f8fafc;
            --card-bg: #ffffff;
            --border: #e2e8f0;
            --border-focus: #10b981;
            --text: #0f172a;
            --text-secondary: #64748b;
            --text-muted: #94a3b8;
            --error: #ef4444;
            --success: #10b981;
            --radius: 12px;
            --radius-lg: 16px;
            --shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 40px rgba(0, 0, 0, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-secondary);
            min-height: 100vh;
            color: var(--text);
            line-height: 1.6;
        }

        /* Page Layout */
        .page {
            min-height: 100vh;
            padding: 24px 16px 48px;
        }

        .container {
            max-width: 480px;
            margin: 0 auto;
        }

        /* Header */
        .header {
            text-align: center;
            margin-bottom: 32px;
            animation: fadeIn 0.6s ease;
        }

        .logo {
            max-width: 240px;
            width: 100%;
            height: auto;
            margin-bottom: 16px;
        }

        .tagline {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-dark);
            margin-bottom: 8px;
        }

        .description {
            font-size: 0.95rem;
            color: var(--text-secondary);
            line-height: 1.6;
        }

        /* Progress Bar */
        .progress-container {
            background: var(--card-bg);
            border-radius: var(--radius-lg);
            padding: 20px 24px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
            animation: slideUp 0.5s ease;
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .progress-label {
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-secondary);
        }

        .progress-percent {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--primary);
        }

        .progress-bar {
            height: 8px;
            background: var(--bg-secondary);
            border-radius: 100px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary) 0%, var(--primary-light) 100%);
            border-radius: 100px;
            width: 0%;
            transition: width 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .progress-steps {
            display: flex;
            justify-content: space-between;
            margin-top: 12px;
        }

        .step-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--border);
            transition: all 0.3s ease;
        }

        .step-dot.active {
            background: var(--primary);
            transform: scale(1.2);
        }

        .step-dot.completed {
            background: var(--primary);
        }

        /* Form Card */
        .form-card {
            background: var(--card-bg);
            border-radius: var(--radius-lg);
            padding: 28px 24px;
            box-shadow: var(--shadow);
            animation: slideUp 0.6s ease 0.1s both;
        }

        /* Sections */
        .section {
            margin-bottom: 28px;
            padding-bottom: 28px;
            border-bottom: 1px solid var(--border);
        }

        .section:last-of-type {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .section-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
        }

        .section-number {
            width: 28px;
            height: 28px;
            background: var(--primary);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            font-weight: 600;
            flex-shrink: 0;
        }

        .section-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text);
        }

        /* Input Groups */
        .input-group {
            margin-bottom: 16px;
        }

        .input-group:last-child {
            margin-bottom: 0;
        }

        .label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text);
            margin-bottom: 6px;
        }

        .label .required {
            color: var(--error);
        }

        .helper {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-bottom: 8px;
        }

        /* Inputs */
        .input {
            width: 100%;
            padding: 12px 16px;
            font-size: 1rem;
            font-family: inherit;
            background: var(--bg-secondary);
            border: 2px solid transparent;
            border-radius: var(--radius);
            color: var(--text);
            transition: all 0.2s ease;
        }

        .input::placeholder {
            color: var(--text-muted);
        }

        .input:focus {
            outline: none;
            border-color: var(--border-focus);
            background: var(--bg);
        }

        .input.error {
            border-color: var(--error);
        }

        .input.success {
            border-color: var(--success);
        }

        .error-text {
            font-size: 0.8rem;
            color: var(--error);
            margin-top: 6px;
            display: none;
        }

        .error-text.show {
            display: block;
            animation: shake 0.4s ease;
        }

        /* Place Autocomplete */
        gmp-place-autocomplete {
            display: block;
            width: 100%;
            --gmp-place-autocomplete-input-padding: 12px 16px;
            --gmp-place-autocomplete-input-font-size: 16px;
            --gmp-place-autocomplete-input-border-radius: 12px;
        }

        .manual-link {
            display: inline-block;
            font-size: 0.8rem;
            color: var(--primary);
            margin-top: 8px;
            cursor: pointer;
            transition: color 0.2s;
        }

        .manual-link:hover {
            color: var(--primary-dark);
            text-decoration: underline;
        }

        .manual-wrapper {
            display: none;
            margin-top: 12px;
            animation: fadeIn 0.3s ease;
        }

        .manual-wrapper.show {
            display: block;
        }

        .back-link {
            display: inline-block;
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-top: 6px;
            cursor: pointer;
        }

        .back-link:hover {
            color: var(--text-secondary);
        }

        .location-tag {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: rgba(16, 185, 129, 0.1);
            color: var(--primary-dark);
            padding: 6px 12px;
            border-radius: 100px;
            font-size: 0.75rem;
            font-weight: 500;
            margin-top: 8px;
        }

        .location-tag.manual {
            background: rgba(251, 191, 36, 0.1);
            color: #b45309;
        }

        /* Distance Options */
        .distance-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .distance-option {
            position: relative;
        }

        .distance-option input {
            position: absolute;
            opacity: 0;
        }

        .distance-card {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 16px 12px;
            background: var(--bg-secondary);
            border: 2px solid transparent;
            border-radius: var(--radius);
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
        }

        .distance-card:hover {
            border-color: var(--border);
        }

        .distance-option input:checked+.distance-card {
            border-color: var(--primary);
            background: rgba(16, 185, 129, 0.05);
        }

        .distance-badge {
            width: 32px;
            height: 32px;
            background: var(--primary);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.85rem;
            margin-bottom: 8px;
        }

        .distance-name {
            font-weight: 500;
            font-size: 0.875rem;
            color: var(--text);
            margin-bottom: 2px;
        }

        .distance-range {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        /* Submit Button */
        .submit-btn {
            width: 100%;
            padding: 16px 24px;
            font-size: 1rem;
            font-weight: 600;
            font-family: inherit;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: var(--radius);
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-top: 24px;
            position: relative;
            overflow: hidden;
        }

        .submit-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .submit-btn:not(:disabled):hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
        }

        .submit-btn:not(:disabled):active {
            transform: translateY(0);
        }

        .submit-btn .spinner {
            display: none;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.7s linear infinite;
        }

        .submit-btn.loading .btn-content {
            opacity: 0;
        }

        .submit-btn.loading .spinner {
            display: block;
            position: absolute;
        }

        /* Footer */
        .footer {
            text-align: center;
            padding: 24px 16px;
            animation: fadeIn 0.6s ease 0.2s both;
        }

        .disclaimer {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-bottom: 12px;
            line-height: 1.6;
        }

        .contact-link {
            color: var(--primary);
            text-decoration: none;
            font-weight: 500;
        }

        .contact-link:hover {
            text-decoration: underline;
        }

        /* Animations */
        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes shake {

            0%,
            100% {
                transform: translateX(0);
            }

            25% {
                transform: translateX(-5px);
            }

            75% {
                transform: translateX(5px);
            }
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.6;
            }
        }

        /* Responsive */
        @media (max-width: 480px) {
            .page {
                padding: 16px 12px 40px;
            }

            .header {
                margin-bottom: 24px;
            }

            .logo {
                max-width: 180px;
            }

            .tagline {
                font-size: 1.25rem;
            }

            .description {
                font-size: 0.875rem;
            }

            .progress-container,
            .form-card {
                padding: 20px 18px;
            }

            .distance-grid {
                grid-template-columns: 1fr;
            }

            .distance-card {
                flex-direction: row;
                justify-content: flex-start;
                gap: 12px;
                text-align: left;
            }

            .distance-badge {
                margin-bottom: 0;
            }
        }

        @media (max-width: 360px) {
            .logo {
                max-width: 160px;
            }

            .tagline {
                font-size: 1.1rem;
            }

            .form-card {
                padding: 16px 14px;
            }
        }

        /* Touch devices */
        @media (hover: none) {

            .input,
            .distance-card,
            .submit-btn {
                min-height: 48px;
            }
        }

        /* Safe areas */
        @supports (padding: env(safe-area-inset-bottom)) {
            .page {
                padding-bottom: calc(48px + env(safe-area-inset-bottom));
            }
        }

        /* Reduced motion */
        @media (prefers-reduced-motion: reduce) {

            *,
            *::before,
            *::after {
                animation-duration: 0.01ms !important;
                transition-duration: 0.01ms !important;
            }
        }
    </style>
</head>

<body>
    <div class="page">
        <div class="container">
            <!-- Header -->
            <header class="header">
                <img src="logo.png" alt="Community Carpool" class="logo" />
                <h1 class="tagline">Share rides. Cut emissions.</h1>
                <p class="description">
                    Match with people on similar routes. Contact details shared only after a match.
                </p>
            </header>

            <!-- Progress Bar -->
            <div class="progress-container">
                <div class="progress-header">
                    <span class="progress-label">Your progress</span>
                    <span class="progress-percent" id="progressPercent">0%</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="progress-steps">
                    <span class="step-dot" id="step1"></span>
                    <span class="step-dot" id="step2"></span>
                    <span class="step-dot" id="step3"></span>
                    <span class="step-dot" id="step4"></span>
                </div>
            </div>

            <!-- Form -->
            <form id="form" class="form-card">
                <!-- Section 1: Details -->
                <div class="section" id="section1">
                    <div class="section-header">
                        <span class="section-number">1</span>
                        <h2 class="section-title">Your details</h2>
                    </div>

                    <div class="input-group">
                        <label class="label" for="firstName">First name</label>
                        <input type="text" id="firstName" class="input" placeholder="Enter your first name" />
                    </div>

                    <div class="input-group">
                        <label class="label" for="email">Email <span class="required">*</span></label>
                        <input type="email" id="email" class="input" placeholder="you@example.com" />
                        <p id="emailError" class="error-text">Please enter a valid email with @</p>
                    </div>
                </div>

                <!-- Section 2: From -->
                <div class="section" id="section2">
                    <div class="section-header">
                        <span class="section-number">2</span>
                        <h2 class="section-title">Starting location</h2>
                    </div>

                    <div class="input-group">
                        <label class="label">Where are you coming from?</label>
                        <p class="helper">Search for a place or enter manually</p>
                        <div id="fromSearchWrapper">
                            <gmp-place-autocomplete id="fromInput"
                                placeholder="Search location"></gmp-place-autocomplete>
                            <span class="manual-link" id="fromManualBtn">Can't find it? Enter manually</span>
                            <div id="fromTag"></div>
                        </div>
                        <div class="manual-wrapper" id="fromManualWrapper">
                            <input type="text" id="fromManual" class="input" placeholder="Type your location" />
                            <span class="back-link" id="fromBackBtn">Back to search</span>
                        </div>
                    </div>
                </div>

                <!-- Section 3: To -->
                <div class="section" id="section3">
                    <div class="section-header">
                        <span class="section-number">3</span>
                        <h2 class="section-title">Destination</h2>
                    </div>

                    <div class="input-group">
                        <label class="label">Where are you going?</label>
                        <p class="helper">Select from search or enter manually</p>
                        <div id="toSearchWrapper">
                            <gmp-place-autocomplete id="toInput"
                                placeholder="Search destination"></gmp-place-autocomplete>
                            <span class="manual-link" id="toManualBtn">Can't find it? Enter manually</span>
                            <div id="toTag"></div>
                        </div>
                        <div class="manual-wrapper" id="toManualWrapper">
                            <input type="text" id="toManual" class="input" placeholder="Type your destination" />
                            <span class="back-link" id="toBackBtn">Back to search</span>
                        </div>
                    </div>
                </div>

                <!-- Section 4: Distance -->
                <div class="section" id="section4">
                    <div class="section-header">
                        <span class="section-number">4</span>
                        <h2 class="section-title">Match distance</h2>
                    </div>

                    <div class="distance-grid">
                        <div class="distance-option">
                            <input type="radio" id="distA" name="distance" value="0-1" />
                            <label class="distance-card" for="distA">
                                <span class="distance-badge">A</span>
                                <div>
                                    <div class="distance-name">Very close</div>
                                    <div class="distance-range">0 to 1 km</div>
                                </div>
                            </label>
                        </div>
                        <div class="distance-option">
                            <input type="radio" id="distB" name="distance" value="1-3" checked />
                            <label class="distance-card" for="distB">
                                <span class="distance-badge">B</span>
                                <div>
                                    <div class="distance-name">Nearby</div>
                                    <div class="distance-range">1 to 3 km</div>
                                </div>
                            </label>
                        </div>
                        <div class="distance-option">
                            <input type="radio" id="distC" name="distance" value="3-5" />
                            <label class="distance-card" for="distC">
                                <span class="distance-badge">C</span>
                                <div>
                                    <div class="distance-name">Local area</div>
                                    <div class="distance-range">3 to 5 km</div>
                                </div>
                            </label>
                        </div>
                        <div class="distance-option">
                            <input type="radio" id="distD" name="distance" value="5-8" />
                            <label class="distance-card" for="distD">
                                <span class="distance-badge">D</span>
                                <div>
                                    <div class="distance-name">Flexible</div>
                                    <div class="distance-range">5 to 8 km</div>
                                </div>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Submit -->
                <button type="submit" id="submitBtn" class="submit-btn" disabled>
                    <span class="btn-content">Continue</span>
                    <span class="spinner"></span>
                </button>
            </form>

            <!-- Footer -->
            <footer class="footer">
                <p class="disclaimer">
                    We don't provide transport services. All arrangements are private and voluntary.
                    <br />
                    Questions? <a href="https://tally.so/r/Xxoqxz" class="contact-link" target="_blank">Contact us</a>
                </p>
            </footer>
        </div>
    </div>

    <script>
        // ============================================
        // CONFIGURATION
        // ============================================
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycby24zyVTnO81DATvp3iXnJc8uCXuizK-rv6ZOrmvEgtw7LGdwkK0ExPCSWaVRm09UujyQ/exec';
        const TALLY_URL = 'https://tally.so/r/eqDG0e';

        // ============================================
        // STATE
        // ============================================
        let fromPlace = null;
        let toPlace = null;
        let isFromManual = false;
        let isToManual = false;

        // ============================================
        // DOM
        // ============================================
        const form = document.getElementById('form');
        const firstName = document.getElementById('firstName');
        const email = document.getElementById('email');
        const emailError = document.getElementById('emailError');
        const submitBtn = document.getElementById('submitBtn');
        const progressFill = document.getElementById('progressFill');
        const progressPercent = document.getElementById('progressPercent');

        // From elements
        const fromSearchWrapper = document.getElementById('fromSearchWrapper');
        const fromManualWrapper = document.getElementById('fromManualWrapper');
        const fromManual = document.getElementById('fromManual');
        const fromManualBtn = document.getElementById('fromManualBtn');
        const fromBackBtn = document.getElementById('fromBackBtn');
        const fromTag = document.getElementById('fromTag');

        // To elements
        const toSearchWrapper = document.getElementById('toSearchWrapper');
        const toManualWrapper = document.getElementById('toManualWrapper');
        const toManual = document.getElementById('toManual');
        const toManualBtn = document.getElementById('toManualBtn');
        const toBackBtn = document.getElementById('toBackBtn');
        const toTag = document.getElementById('toTag');

        // ============================================
        // PROGRESS BAR
        // ============================================
        function updateProgress() {
            let completed = 0;
            const total = 4;

            // Step 1: Name and email
            const hasName = firstName.value.trim().length > 0;
            const hasEmail = email.value.includes('@') && email.value.includes('.');
            if (hasName && hasEmail) completed++;
            document.getElementById('step1').classList.toggle('completed', hasName && hasEmail);
            document.getElementById('step1').classList.toggle('active', hasName || hasEmail);

            // Step 2: From location
            const hasFrom = fromPlace || (isFromManual && fromManual.value.trim());
            if (hasFrom) completed++;
            document.getElementById('step2').classList.toggle('completed', hasFrom);
            document.getElementById('step2').classList.toggle('active', !hasFrom && (hasName || hasEmail));

            // Step 3: To location
            const hasTo = toPlace || (isToManual && toManual.value.trim());
            if (hasTo) completed++;
            document.getElementById('step3').classList.toggle('completed', hasTo);
            document.getElementById('step3').classList.toggle('active', !hasTo && hasFrom);

            // Step 4: Distance (always completed since we have a default)
            completed++;
            document.getElementById('step4').classList.add('completed');

            const percent = Math.round((completed / total) * 100);
            progressFill.style.width = percent + '%';
            progressPercent.textContent = percent + '%';

            // Enable submit if all required fields are filled
            const isValid = hasName && hasEmail && hasFrom && hasTo;
            submitBtn.disabled = !isValid;
        }

        // ============================================
        // EMAIL VALIDATION
        // ============================================
        function validateEmail(value) {
            return value.includes('@') && /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(value);
        }

        email.addEventListener('blur', () => {
            const value = email.value.trim();
            if (value && !validateEmail(value)) {
                emailError.classList.add('show');
                email.classList.add('error');
            } else {
                emailError.classList.remove('show');
                email.classList.remove('error');
                if (value && validateEmail(value)) {
                    email.classList.add('success');
                }
            }
            updateProgress();
        });

        email.addEventListener('input', () => {
            emailError.classList.remove('show');
            email.classList.remove('error', 'success');
            updateProgress();
        });

        firstName.addEventListener('input', updateProgress);

        // ============================================
        // MANUAL LOCATION TOGGLE
        // ============================================
        function setupLocationToggle(type) {
            const searchWrapper = type === 'from' ? fromSearchWrapper : toSearchWrapper;
            const manualWrapper = type === 'from' ? fromManualWrapper : toManualWrapper;
            const manualInput = type === 'from' ? fromManual : toManual;
            const manualBtn = type === 'from' ? fromManualBtn : toManualBtn;
            const backBtn = type === 'from' ? fromBackBtn : toBackBtn;
            const tag = type === 'from' ? fromTag : toTag;

            manualBtn.addEventListener('click', () => {
                searchWrapper.style.display = 'none';
                manualWrapper.classList.add('show');
                manualInput.focus();
                if (type === 'from') {
                    isFromManual = true;
                    fromPlace = null;
                } else {
                    isToManual = true;
                    toPlace = null;
                }
                tag.innerHTML = '';
                updateProgress();
            });

            backBtn.addEventListener('click', () => {
                searchWrapper.style.display = 'block';
                manualWrapper.classList.remove('show');
                manualInput.value = '';
                if (type === 'from') {
                    isFromManual = false;
                } else {
                    isToManual = false;
                }
                updateProgress();
            });

            manualInput.addEventListener('input', updateProgress);
        }

        setupLocationToggle('from');
        setupLocationToggle('to');

        // ============================================
        // LOCATION TAG
        // ============================================
        function showTag(type, name, source) {
            const tag = type === 'from' ? fromTag : toTag;
            const icon = source === 'google' ? 'üìç' : '‚úèÔ∏è';
            const className = source === 'manual' ? 'location-tag manual' : 'location-tag';
            tag.innerHTML = `<span class="${className}">${icon} ${name.substring(0, 35)}${name.length > 35 ? '...' : ''}</span>`;
        }

        // ============================================
        // GOOGLE PLACES
        // ============================================
        async function initAutocomplete() {
            const fromEl = document.getElementById('fromInput');
            const toEl = document.getElementById('toInput');

            fromEl.componentRestrictions = { country: 'ae' };
            toEl.componentRestrictions = { country: 'ae' };
            fromEl.types = ['establishment', 'geocode'];
            toEl.types = ['establishment', 'geocode'];

            fromEl.addEventListener('gmp-placeselect', (e) => {
                fromPlace = e.place;
                showTag('from', fromPlace.displayName || 'Selected', 'google');
                updateProgress();
            });

            toEl.addEventListener('gmp-placeselect', (e) => {
                toPlace = e.place;
                showTag('to', toPlace.displayName || 'Selected', 'google');
                updateProgress();
            });
        }

        // ============================================
        // FORM SUBMIT
        // ============================================
        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            const firstNameVal = firstName.value.trim();
            const emailVal = email.value.trim();
            const distance = document.querySelector('input[name="distance"]:checked').value;

            if (!validateEmail(emailVal)) {
                emailError.classList.add('show');
                email.classList.add('error');
                email.focus();
                return;
            }

            // Get locations
            let fromLocation = '', fromLatLng = '', fromSource = '';
            let toLocation = '', toLatLng = '', toSource = '';

            if (isFromManual) {
                fromLocation = fromManual.value.trim();
                fromLatLng = 'manual';
                fromSource = 'manual';
            } else if (fromPlace) {
                await fromPlace.fetchFields({ fields: ['formattedAddress', 'location'] });
                fromLocation = fromPlace.formattedAddress || '';
                fromLatLng = `${fromPlace.location.lat()},${fromPlace.location.lng()}`;
                fromSource = 'google';
            }

            if (isToManual) {
                toLocation = toManual.value.trim();
                toLatLng = 'manual';
                toSource = 'manual';
            } else if (toPlace) {
                await toPlace.fetchFields({ fields: ['formattedAddress', 'location'] });
                toLocation = toPlace.formattedAddress || '';
                toLatLng = `${toPlace.location.lat()},${toPlace.location.lng()}`;
                toSource = 'google';
            }

            // Loading state
            submitBtn.classList.add('loading');
            submitBtn.disabled = true;

            const data = {
                firstName: firstNameVal,
                email: emailVal,
                fromLocation, fromLatLng, fromSource,
                toLocation, toLatLng, toSource,
                distance
            };

            try {
                // Send to Google Sheets
                await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
            } catch (err) {
                console.log('Sheet save attempted');
            }

            // Redirect to Tally
            const params = new URLSearchParams({
                FirstName: firstNameVal,
                Email: emailVal,
                FromLocation: fromLocation,
                FromLatLng: fromLatLng,
                ToLocation: toLocation,
                ToLatLng: toLatLng,
                Distance: distance
            });

            window.location.href = `${TALLY_URL}?${params.toString()}`;
        });

        // Initial progress update
        updateProgress();
    </script>

    <script
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyARzmbbhT0ki5-bZ-43pkkPyJNmOCTz4P0&libraries=places&v=beta&callback=initAutocomplete"
        async defer></script>
</body>

</html>
